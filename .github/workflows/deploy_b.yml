name: FullWorkflow-Deploy-b-Simulation

# Simulation version of deploy_b.yml that uses docker-simulation.yml
# Perfect for learning and testing without Azure credentials

on:
  push:
    branches:
      - main
    paths:
      - 'model/b/**'
      - '.github/workflows/deploy_b_simulation.yml'
      - '.github/workflows/docker-simulation.yml'

permissions:
  contents: write
  pull-requests: write
  id-token: write
  packages: write

jobs:
  style:
    uses: ./.github/workflows/style.yml

  tests_b:
    uses: ./.github/workflows/tests.yml
    with:
      src_path: "model/b"

  python_style_b:
    uses: ./.github/workflows/python_style.yml
    with:
      src_path: "model/b"

  release:
    needs: [style, tests_b, python_style_b]
    uses: ./.github/workflows/release.yaml

  docker_simulation_b:
    name: Build Docker Image (Simulation)
    needs: release
    # Only run if release was created OR if we're testing the workflow
    if: |
      needs.release.outputs.b-release_created == 'true' ||
      contains(github.event.head_commit.message, '[test-docker]')
    uses: ./.github/workflows/docker-simulation.yml
    with:
      image_tag: ${{ needs.release.outputs.b-tag_name || 'test' }}
      build_context: "b"

  summary:
    name: Deployment Summary
    needs: [release, docker_simulation_b]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## 🚀 Model B Deployment Summary (Simulation Mode)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflow Results" >> $GITHUB_STEP_SUMMARY
          echo "- Style checks: ${{ needs.style.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unit tests: ${{ needs.tests_b.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python style: ${{ needs.python_style_b.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Release: ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker build: ${{ needs.docker_simulation_b.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.release.outputs.b-release_created }}" = "true" ]; then
            echo "### 🎉 Release Created" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag**: ${{ needs.release.outputs.b-tag_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Docker image built**: Yes (simulation)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ℹ️ No Release" >> $GITHUB_STEP_SUMMARY
            echo "No releasable commits found for model/b" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Note**: Running in simulation mode. No images pushed to registry." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To test Docker build without release, add \`[test-docker]\` to commit message." >> $GITHUB_STEP_SUMMARY
